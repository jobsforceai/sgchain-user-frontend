# Backend Instructions for Emoji PIN System

This document outlines the backend changes required to support the new emoji-based PIN system for the user wallet. The goal is to create a secure and scalable system where the list of allowed emojis is managed centrally by the backend.

## 1. New Endpoint: Fetch Allowed Emojis

A new configuration endpoint must be created to provide the frontend with the list of valid characters for the PIN keypad.

*   **Endpoint**: `GET /api/config/emojis`
*   **Method**: `GET`
*   **Description**: Returns a JSON object containing arrays of allowed emojis, categorized for potential future use.
*   **Success Response (200 OK)**:
    ```json
    {
      "spiritual": [
        "ðŸ•‰ï¸", "â˜¸ï¸", "ðŸ›•", "ðŸª”", "ðŸ“¿", "ðŸ§˜", "ðŸ§¿", "ðŸª¬", "ðŸ›", "ðŸ•¯ï¸", "â˜¯ï¸", "âœ¡ï¸", "â˜¦ï¸", "âœï¸", "â˜ªï¸", "ðŸ•Ž"
      ],
      "mudra": [
        "ðŸ™", "ðŸ¤²", "ðŸ‘", "ðŸ«´", "ðŸ«³", "ðŸ«±", "ðŸ«²", "âœ‹", "ðŸ¤š", "ðŸ–", "ðŸ‘‹", "â˜ï¸", "ðŸ‘†", "ðŸ‘‡", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ«µ", "ðŸ‘Œ", "ðŸ¤Œ", "ðŸ¤", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤˜", "ðŸ¤™", "ðŸ‘", "ðŸ‘Ž", "âœŠ", "ðŸ‘Š", "ðŸ¤›", "ðŸ¤œ", "ðŸ‘", "ðŸ™Œ", "ðŸ¤", "âœï¸", "ðŸ’ª", "ðŸ¤³", "ðŸ«¶", "ðŸ––", "ðŸ–•"
      ],
      "fullSet": [
        // This array should contain all ~4,000 fully-qualified emojis
        "ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜Š", "ðŸ˜‡", "..." 
      ]
    }
    ```

## 2. Implementation: Sourcing Emojis

The `fullSet` array should not be hardcoded. It must be generated by parsing the official Unicode emoji data file.

1.  **Download the Data File**: The backend should download and store the `emoji-test.txt` file from the official Unicode source:
    *   **URL**: [https://unicode.org/Public/emoji/15.0/emoji-test.txt](https://unicode.org/Public/emoji/15.0/emoji-test.txt) (or the latest version)

2.  **Parse the File**: Create a script to parse this file. The logic should only include "fully-qualified" emojis to ensure maximum compatibility.

    Here is a reference implementation in TypeScript/Node.js:
    ```typescript
    import fs from "fs";
    import path from "path";

    export function loadAllowedEmoji() {
      const file = fs.readFileSync(
        path.join(__dirname, "emoji-test.txt"), // Assumes the file is stored with the source
        "utf8"
      );

      const emojis: string[] = [];

      for (const line of file.split("\n")) {
        // Skip comments or blank lines
        if (!line.trim() || line.startsWith("#")) continue;

        // Line format: "1F600 ; fully-qualified # ðŸ˜€ grinning face"
        const [codepointsPart, rest] = line.split(";");
        if (!rest) continue;

        const status = rest.split("#")[0].trim();
        if (status !== "fully-qualified") continue;

        const codepoints = codepointsPart.trim().split(" ");
        const emojiChar = String.fromCodePoint(
          ...codepoints.map(cp => parseInt(cp, 16))
        );
        emojis.push(emojiChar);
      }

      return emojis;
    }
    ```
    The `spiritual` and `mudra` arrays can be hardcoded as they are curated subsets.

## 3. Update PIN Validation Logic

The existing PIN validation endpoints must be updated to support the new character set.

*   **Endpoints to Update**:
    *   `POST /api/me/wallet/set-pin`
    *   `POST /api/me/wallet/verify-pin`

*   **Required Changes**:
    1.  The validation logic must **remove any "numeric-only" checks** on the `pin` field.
    2.  It should validate that the incoming `pin` is a string of exactly **4 characters**.
    3.  It must check that **every character** in the `pin` string exists within the `fullSet` of allowed emojis generated in Step 2. If any character is invalid, the request should be rejected with a `400 Bad Request` error.

This centralized approach ensures that the frontend and backend always share the same set of valid PIN characters.
